<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>HyperFS æ–‡ä»¶ç®¡ç†å®¢æˆ·ç«¯</title>
        <style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
                    Roboto, "Helvetica Neue", Arial, sans-serif;
                background-color: #f5f5f5;
                padding: 20px;
                margin: 0;
            }

            /* é…ç½®æ æ ·å¼ */
            .config-bar {
                max-width: 900px;
                margin: 0 auto 20px auto;
                background: #343a40;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                display: flex;
                align-items: center;
                gap: 10px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }
            .config-bar label {
                font-weight: bold;
                font-size: 14px;
            }
            .config-bar input {
                flex: 1;
                padding: 8px 12px;
                border-radius: 4px;
                border: 1px solid #ced4da;
                font-size: 14px;
            }
            .config-bar button {
                background-color: #28a745;
                color: white;
                border: none;
                padding: 8px 15px;
                border-radius: 4px;
                cursor: pointer;
                font-weight: bold;
                transition: background 0.2s;
            }
            .config-bar button:hover {
                background-color: #218838;
            }

            /* ä¸»å®¹å™¨ */
            .container {
                max-width: 900px;
                margin: 0 auto;
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }

            /* é¡¶éƒ¨å·¥å…·æ  */
            .toolbar {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
                padding-bottom: 10px;
                border-bottom: 1px solid #eee;
            }
            .path-nav {
                font-size: 1.1em;
                font-weight: bold;
                color: #333;
            }
            .btn {
                padding: 8px 15px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                transition: background 0.2s;
                font-size: 14px;
            }
            .btn-primary {
                background-color: #007bff;
                color: white;
            }
            .btn-primary:hover {
                background-color: #0056b3;
            }
            .btn-secondary {
                background-color: #6c757d;
                color: white;
                margin-right: 10px;
            }
            .btn-secondary:disabled {
                background-color: #ccc;
                cursor: not-allowed;
            }

            /* æ–‡ä»¶åˆ—è¡¨è¡¨æ ¼ */
            table {
                width: 100%;
                border-collapse: collapse;
            }
            th,
            td {
                text-align: left;
                padding: 12px;
                border-bottom: 1px solid #eee;
            }
            th {
                background-color: #fafafa;
                font-weight: 600;
                color: #555;
            }
            tr:hover {
                background-color: #f0f8ff;
                cursor: pointer;
            }

            /* å›¾æ ‡ä¸æ ·å¼ */
            .icon {
                margin-right: 8px;
                width: 20px;
                text-align: center;
                display: inline-block;
            }
            .folder-row {
                font-weight: 500;
                color: #0056b3;
            }
            .file-row {
                color: #333;
            }
            .empty-tip {
                text-align: center;
                color: #999;
                padding: 20px;
            }

            /* ä¸Šä¼ åŒºåŸŸ */
            #uploadInput {
                display: none;
            }
        </style>
    </head>
    <body>
        <div class="config-bar">
            <label for="serverUrl">æœåŠ¡å™¨åœ°å€:</label>
            <input
                type="text"
                id="serverUrl"
                placeholder="ä¾‹å¦‚ http://localhost:8080"
                value="http://localhost:8080"
            />
            <button onclick="connectToServer()">è¿æ¥ / åˆ·æ–°</button>
        </div>

        <div class="container">
            <div class="toolbar">
                <div>
                    <button
                        id="backBtn"
                        class="btn btn-secondary"
                        onclick="goBack()"
                        disabled
                    >
                        â† è¿”å›ä¸Šä¸€çº§
                    </button>
                    <span id="currentPath" class="path-nav"
                        >å½“å‰ç›®å½• ID: 0</span
                    >
                </div>
                <div>
                    <input
                        type="file"
                        id="uploadInput"
                        onchange="handleFileSelect(this)"
                    />
                    <button
                        class="btn btn-primary"
                        onclick="document.getElementById('uploadInput').click()"
                    >
                        + ä¸Šä¼ æ–‡ä»¶
                    </button>
                </div>
            </div>

            <table id="fileTable">
                <thead>
                    <tr>
                        <th width="50%">åç§°</th>
                        <th width="15%">å¤§å°</th>
                        <th width="25%">ä¸Šä¼ æ—¶é—´</th>
                        <th width="10%">ä¸‹è½½é‡</th>
                    </tr>
                </thead>
                <tbody id="fileListBody">
                    <tr>
                        <td colspan="4" class="empty-tip">
                            è¯·å…ˆç‚¹å‡»ä¸Šæ–¹â€œè¿æ¥â€æŒ‰é’®åŠ è½½æ•°æ®
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <script>
            // å…¨å±€å˜é‡
            let apiBaseUrl = "http://localhost:8080";
            let currentParentId = 0;
            let pathHistory = [];

            // åˆå§‹åŒ–ï¼šä» LocalStorage è¯»å–ä¸Šæ¬¡ä½¿ç”¨çš„åœ°å€
            document.addEventListener("DOMContentLoaded", () => {
                const savedUrl = localStorage.getItem("hyperfs_server_url");
                if (savedUrl) {
                    document.getElementById("serverUrl").value = savedUrl;
                    apiBaseUrl = savedUrl;
                }
                // è‡ªåŠ¨å°è¯•åŠ è½½ä¸€æ¬¡
                connectToServer();
            });

            /**
             * è¿æ¥æœåŠ¡å™¨å¹¶é‡ç½®è§†å›¾
             */
            function connectToServer() {
                const inputUrl = document
                    .getElementById("serverUrl")
                    .value.trim();
                if (!inputUrl) {
                    alert("è¯·è¾“å…¥æœåŠ¡å™¨åœ°å€");
                    return;
                }

                // å»é™¤æœ«å°¾æ–œæ 
                apiBaseUrl = inputUrl.endsWith("/")
                    ? inputUrl.slice(0, -1)
                    : inputUrl;

                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem("hyperfs_server_url", apiBaseUrl);

                // é‡ç½®çŠ¶æ€
                currentParentId = 0;
                pathHistory = [];
                updateUI();

                // åŠ è½½æ ¹ç›®å½•
                loadFileList(0);
            }

            /**
             * åŠ è½½æ–‡ä»¶åˆ—è¡¨
             */
            async function loadFileList(parentId) {
                const tbody = document.getElementById("fileListBody");
                tbody.innerHTML =
                    '<tr><td colspan="4" class="empty-tip">æ­£åœ¨åŠ è½½...</td></tr>';

                try {
                    const response = await fetch(
                        `${apiBaseUrl}/list?parentId=${parentId}`
                    );
                    if (!response.ok)
                        throw new Error(`HTTP é”™è¯¯: ${response.status}`);

                    const data = await response.json();
                    renderTable(data.nodes);

                    // æ›´æ–°å½“å‰ ID çŠ¶æ€
                    currentParentId = parentId;
                    updateUI();
                } catch (error) {
                    console.error(error);
                    tbody.innerHTML = `<tr><td colspan="4" class="empty-tip" style="color:red">åŠ è½½å¤±è´¥: ${error.message}<br>è¯·æ£€æŸ¥æœåŠ¡å™¨åœ°å€æ˜¯å¦æ­£ç¡®</td></tr>`;
                }
            }

            /**
             * æ¸²æŸ“è¡¨æ ¼
             */
            function renderTable(nodes) {
                const tbody = document.getElementById("fileListBody");
                tbody.innerHTML = "";

                if (!nodes || nodes.length === 0) {
                    tbody.innerHTML =
                        '<tr><td colspan="4" class="empty-tip">æ­¤ç›®å½•ä¸ºç©º</td></tr>';
                    return;
                }

                // æ’åºï¼šæ–‡ä»¶å¤¹åœ¨å‰ï¼Œæ–‡ä»¶åœ¨å
                nodes.sort(
                    (a, b) =>
                        (b.nodeType === true ? 1 : 0) -
                        (a.nodeType === true ? 1 : 0)
                );

                nodes.forEach((node) => {
                    const tr = document.createElement("tr");
                    const isFolder = node.nodeType === true;

                    tr.className = isFolder ? "folder-row" : "file-row";

                    if (isFolder) {
                        tr.ondblclick = () => enterFolder(node.id);
                    } else {
                        tr.ondblclick = () =>
                            alert(`ä¸‹è½½åŠŸèƒ½æš‚æœªå®ç° (File ID: ${node.id})`);
                    }

                    const icon = isFolder ? "ğŸ“" : "ğŸ“„";
                    const sizeStr = isFolder ? "-" : formatBytes(node.size);

                    // ç®€å•çš„æ—¶é—´æ ¼å¼åŒ–
                    let dateStr = "-";
                    if (node.uploadTime) {
                        dateStr = new Date(node.uploadTime).toLocaleString();
                    }

                    tr.innerHTML = `
                <td><span class="icon">${icon}</span>${escapeHtml(
                        node.name
                    )}</td>
                <td>${sizeStr}</td>
                <td>${dateStr}</td>
                <td>${node.downloadCount || 0}</td>
            `;
                    tbody.appendChild(tr);
                });
            }

            /**
             * è¿›å…¥æ–‡ä»¶å¤¹
             */
            function enterFolder(folderId) {
                pathHistory.push(currentParentId);
                loadFileList(folderId);
            }

            /**
             * è¿”å›ä¸Šä¸€çº§
             */
            function goBack() {
                if (pathHistory.length > 0) {
                    const prevId = pathHistory.pop();
                    loadFileList(prevId);
                }
            }

            /**
             * å¤„ç†æ–‡ä»¶ä¸Šä¼ 
             */
            async function handleFileSelect(input) {
                if (input.files.length === 0) return;

                const file = input.files[0];
                const fileName = file.name;

                // ç®€å•çš„ UI åé¦ˆ
                const originalBtnText =
                    document.querySelector(".btn-primary").innerText;
                document.querySelector(".btn-primary").innerText = "ä¸Šä¼ ä¸­...";
                document.querySelector(".btn-primary").disabled = true;

                try {
                    const encodedFileName = encodeURIComponent(fileName);

                    const response = await fetch(`${apiBaseUrl}/upload`, {
                        method: "POST",
                        headers: {
                            "X-Parent-Id": currentParentId.toString(),
                            "X-File-Name": encodedFileName,
                            "Content-Type": "application/octet-stream",
                        },
                        body: file,
                    });

                    if (response.ok) {
                        // ä¸Šä¼ æˆåŠŸåé‡æ–°åŠ è½½å½“å‰åˆ—è¡¨
                        await loadFileList(currentParentId);
                        alert("ä¸Šä¼ æˆåŠŸï¼");
                    } else {
                        const errText = await response.text();
                        alert("ä¸Šä¼ å¤±è´¥: " + errText);
                    }
                } catch (error) {
                    console.error(error);
                    alert("ä¸Šä¼ å‡ºé”™: " + error.message);
                } finally {
                    input.value = "";
                    document.querySelector(".btn-primary").innerText =
                        originalBtnText;
                    document.querySelector(".btn-primary").disabled = false;
                }
            }

            /**
             * UI è¾…åŠ©å‡½æ•°
             */
            function updateUI() {
                document.getElementById(
                    "currentPath"
                ).innerText = `å½“å‰ç›®å½• ID: ${currentParentId}`;
                document.getElementById("backBtn").disabled =
                    pathHistory.length === 0;
            }

            function formatBytes(bytes, decimals = 2) {
                if (bytes === 0) return "0 B";
                const k = 1024;
                const dm = decimals < 0 ? 0 : decimals;
                const sizes = ["B", "KB", "MB", "GB", "TB"];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return (
                    parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) +
                    " " +
                    sizes[i]
                );
            }

            function escapeHtml(text) {
                if (!text) return text;
                return text
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }
        </script>
    </body>
</html>