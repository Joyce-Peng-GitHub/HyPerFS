<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>é«˜æ€§èƒ½æ–‡ä»¶æœåŠ¡å™¨æµ‹è¯•ç»ˆç«¯</title>
        <style>
            :root {
                --primary: #059669;
                --bg: #f0fdf4;
                --card-bg: #ffffff;
                --border: #bbf7d0;
                --text: #1e293b;
            }
            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
                    Roboto, sans-serif;
                background-color: var(--bg);
                color: var(--text);
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
            }
            h1 {
                color: #047857;
            }
            h2 {
                border-bottom: 2px solid var(--primary);
                padding-bottom: 10px;
                margin-top: 30px;
                font-size: 1.2em;
            }
            .card {
                background: var(--card-bg);
                border: 1px solid var(--border);
                border-radius: 8px;
                padding: 20px;
                margin-bottom: 20px;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            }
            .form-group {
                margin-bottom: 15px;
            }
            label {
                display: block;
                margin-bottom: 5px;
                font-weight: bold;
                font-size: 0.9em;
                color: #374151;
            }
            input[type="text"],
            select,
            textarea {
                width: 100%;
                padding: 8px;
                border: 1px solid #cbd5e1;
                border-radius: 4px;
                box-sizing: border-box;
                font-family: monospace;
            }
            textarea {
                height: 80px;
                resize: vertical;
            }
            button {
                background-color: var(--primary);
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                transition: background 0.2s;
            }
            button:hover {
                background-color: #047857;
            }
            #response-area {
                background: #0f172a;
                color: #4ade80;
                padding: 15px;
                border-radius: 4px;
                overflow-x: auto;
                white-space: pre-wrap;
                font-family: "Menlo", "Monaco", monospace;
                min-height: 100px;
                font-size: 0.85em;
            }
            .badge {
                display: inline-block;
                padding: 2px 6px;
                border-radius: 4px;
                font-size: 0.75em;
                font-weight: bold;
                margin-left: 5px;
            }
            .badge-fast {
                background: #dcfce7;
                color: #166534;
                border: 1px solid #86efac;
            }
        </style>
    </head>
    <body>
        <h1>âš¡ é«˜æ€§èƒ½æ–‡ä»¶æœåŠ¡å™¨æµ‹è¯•</h1>

        <div class="card">
            <div class="form-group">
                <label for="serverUrl">ç›®æ ‡æœåŠ¡å™¨åœ°å€ (URL)</label>
                <input
                    type="text"
                    id="serverUrl"
                    value="http://localhost:3000/upload"
                    placeholder="ä¾‹å¦‚: http://localhost:3000/upload"
                />
            </div>
        </div>

        <div class="card">
            <h2>æ–‡ä»¶ä¸Šä¼ æµ‹è¯•</h2>

            <div class="form-group">
                <label>ä¸Šä¼ æ¨¡å¼</label>
                <select id="uploadMode" onchange="toggleHint()">
                    <option value="raw">
                        ğŸš€ äºŒè¿›åˆ¶æµ (POST) - é«˜æ€§èƒ½/æ— Boundary
                    </option>
                    <option value="form">
                        ğŸ“¦ è¡¨å•æ¨¡å¼ (POST) - ä¼ ç»Ÿ Multipart
                    </option>
                </select>
                <div
                    id="mode-hint"
                    style="
                        font-size: 0.85em;
                        color: #666;
                        margin-top: 5px;
                        background: #f1f5f9;
                        padding: 8px;
                        border-radius: 4px;
                    "
                >
                    å½“å‰æ¨¡å¼ï¼šç›´æ¥å°†æ–‡ä»¶å­—èŠ‚å†™å…¥ Request
                    Bodyã€‚é€‚åˆå¤§æ–‡ä»¶ä¼ è¾“ï¼ŒæœåŠ¡å™¨æ— éœ€è§£æ multipartã€‚
                </div>
            </div>

            <div class="form-group">
                <label>é€‰æ‹©æ–‡ä»¶</label>
                <input type="file" id="fileInput" />
            </div>

            <button onclick="uploadFile()">å¼€å§‹ä¸Šä¼ </button>
        </div>

        <div class="card">
            <label>æœåŠ¡å™¨å“åº”</label>
            <div id="response-area">ç­‰å¾…æ“ä½œ...</div>
        </div>

        <script>
            function log(data) {
                const area = document.getElementById("response-area");
                const content =
                    typeof data === "object"
                        ? JSON.stringify(data, null, 2)
                        : data;
                area.textContent =
                    `[${new Date().toLocaleTimeString()}] ${content}\n\n` +
                    area.textContent;
            }

            function toggleHint() {
                const mode = document.getElementById("uploadMode").value;
                const hint = document.getElementById("mode-hint");
                if (mode === "raw") {
                    hint.textContent =
                        "å½“å‰æ¨¡å¼ï¼šç›´æ¥å°†æ–‡ä»¶å­—èŠ‚å†™å…¥ Request Bodyã€‚é€‚åˆå¤§æ–‡ä»¶ä¼ è¾“ï¼ŒæœåŠ¡å™¨æ— éœ€è§£æ multipartã€‚";
                } else {
                    hint.textContent =
                        "å½“å‰æ¨¡å¼ï¼šå°†æ–‡ä»¶å°è£…åœ¨ multipart/form-data ä¸­ã€‚åŒ…å« Boundary åˆ†ç•Œç¬¦ï¼Œå…¼å®¹æ€§å¥½ä½†æœ‰è§£æå¼€é”€ã€‚";
                }
            }

            async function uploadFile() {
                const fileInput = document.getElementById("fileInput");
                const file = fileInput.files[0];
                const baseUrl = document.getElementById("serverUrl").value;
                const mode = document.getElementById("uploadMode").value;

                if (!file) {
                    alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡ä»¶ï¼");
                    return;
                }

                // 1. å¤„ç† URL æŸ¥è¯¢å‚æ•° (filename)
                const separator = baseUrl.includes("?") ? "&" : "?";
                // ä½¿ç”¨ encodeURIComponent ç¡®ä¿æ–‡ä»¶åå®‰å…¨ä¼ è¾“
                const uploadUrl = `${baseUrl}${separator}filename=${encodeURIComponent(
                    file.name
                )}`;

                log(
                    `æ­£åœ¨ä¸Šä¼  (${
                        mode === "raw" ? "POST äºŒè¿›åˆ¶æµ" : "POST è¡¨å•"
                    })...`
                );
                log(`ç›®æ ‡: ${uploadUrl}`);

                try {
                    let options = {};

                    if (mode === "raw") {
                        // === å…³é”®é€»è¾‘ï¼šPUT äºŒè¿›åˆ¶æµ ===
                        // Body ç›´æ¥è®¾ç½®ä¸º file å¯¹è±¡ï¼ˆå®ƒæ˜¯ä¸€ä¸ª Blob/Binaryï¼‰
                        options = {
                            method: "POST",
                            headers: {
                                // å»ºè®®è®¾ç½®ä¸º generic binary æˆ–è€…æ–‡ä»¶çš„çœŸå®ç±»å‹
                                "Content-Type": "application/octet-stream",
                            },
                            body: file,
                        };
                    } else {
                        // === ä¼ ç»Ÿé€»è¾‘ï¼šPOST FormData ===
                        const formData = new FormData();
                        formData.append("file", file);
                        options = {
                            method: "POST",
                            body: formData,
                        };
                    }

                    const response = await fetch(uploadUrl, options);
                    const result = await parseResponse(response);
                    log(result);
                } catch (error) {
                    log(`ä¸Šä¼ å¤±è´¥: ${error.message}`);
                }
            }

            async function parseResponse(response) {
                const text = await response.text();
                try {
                    return JSON.parse(text);
                } catch (e) {
                    return `Status: ${response.status}\nBody: ${text}`;
                }
            }
        </script>
    </body>
</html>
