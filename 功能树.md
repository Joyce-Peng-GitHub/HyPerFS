# 功能树

## 服务端

数据库：

```sqlite
PRAGMA journal_mode=WAL;
PRAGMA synchronous=NORMAL;
PRAGMA busy_timeout=5000;

CREATE TABLE IF NOT EXISTS file_storage (
	hash TEXT NOT NULL PRIMARY KEY,
	sz INTEGER NOT NULL,
	ref_cnt INTEGER NOT NULL DEFAULT 1,
	created_at TEXT DEFAULT CURRENT_TIMESTAMP
) STRICT;

CREATE TABLE IF NOT EXISTS file_meta (
	id INTEGER PRIMARY KEY,
	parent_id INTEGER NOT NULL DEFAULT 0,
	name TEXT NOT NULL,
	is_folder INTEGER NOT NULL,
	hash TEXT,
	sz INTEGER DEFAULT 0,
	up_tm INTEGER NOT NULL,
	down_cnt INTEGER NOT NULL DEFAULT 0,
	UNIQUE (parent_id, name)
) STRICT;
CREATE INDEX IF NOT EXISTS idx_parent_id
ON file_meta (parent_id);
```



类：

- `HttpServerHandler`
  - 对于每个客户会被创建一个实例。
  - 存储`FileService`单例、`UploadSession`引用。
  - 处理请求，路由分发。如果有异常，告诉客户端。
  - 解析HTTP头或者查询字符串，调用`fileService`对应的方法。
  - 异常处理（`exceptionCaught`）：全局捕获，统一格式化错误响应。
  - 关闭通道（`channelInactive`）：如果有上传或下载任务，调用`abort`方法。
- `FileService`
  - 保存`DatabaseService`单例的引用。
  - 上传启动`startUpload()`：返回一个新的`UploadSession`实例。
  - 上传结束`completeUpload(uploadSession, parentId, filename)`：`databaseService`插入文件，并通过返回值判断是否重复。重复的话直接删除；没有就将临时文件原子移动到存储目录（重命名为哈希值），用获取的哈希和文件大小给`databaseService`保存文件。若原子移动失败（如并发冲突、跨分区移动等原因），尝试标准移动，仍失败则让`databaseService`回滚插入操作，并抛出异常。如果有任何异常，调用`uploadSession.abort()`，并转发异常。
  - 上传中断：告诉`uploadSession`。
  - 列表请求：调用数据库，返回列表。
  - 下载启动`DefaultFileRegion startDownload(id, startRange, startLength)`：调用数据库获得信息，创建`DefaultFileRegion`。
  - 删除请求：调用`databaseService`。
- `UploadSession`
  - 保存临时文件句柄`File temporaryFile`、NIO文件通道`fileChannel`、哈希计算器`messageDigest`和当前已经收到的字节数`receivedBytes`。
  - 处理内容块`processChunk`：先计算哈希，再保存到文件。
  - 重命名临时文件`rename(path)`：用户指定路径。提供这个接口，有利于后续决定是否升级到`/data/1a/2b/...`这种模式。
  - 删除临时文件`delete`。
  - 提供哈希值`getHashString`。
  - 提供文件大小`getSize`。
  - 关闭`close`：关闭通道。
  - 取消`abort`：关闭，删除临时文件。
- `DatabaseFactory`
  - 单例类，持有一个`HikariDataSource dataSource`。
  - 构造时，如果不存在则创建数据库和表。

- `DatabaseService`
  - `InsertFileResult`
    - `boolean isDuplicated`
    - `long id`

  - 存储`fileStorageDao`、`fileMetaDao`
  - 查询文件`boolean existsByHash(hashString) `：接受哈希值和文件大小，调用`FileStorageDao`查询有没有这个哈希值的文件，如果有就检查大小。如果有哈希碰撞就抛异常，因为理论上不会有这种事。查到了返回实体，没查到返回空引用。
  - 列出目录`ArrayList<FileMetaEntity> getList(parentId)`：接受一个节点ID。调用`FileMetaDao`查询。
  - 保存文件节点`InsertFileResult insertdFile(parentId, filename, hashString, size)`：检查对应目录下有没有同名节点。没有的话，分别在两张表上插入，然后返回即可。如果有同名节点且是文件夹，抛出受检异常。如果有同名且哈希值相同，直接返回。如果同名但哈希不同，则减少原文件的引用计数。检查文件是否存在，不存在就插入，存在就增加引用计数。获取时间，创建节点，返回。
  - 撤销插入`revokeFileInsertion(insertFileResult)`：用ID获取哈希值，用哈希值查`file_storage`记录。减少引用计数，删除ID对应的节点。
  - 创建文件夹节点`insertFolder(parentId, filename)`：接受父文件夹ID、文件夹名，返回节点ID。检查对应目录下有没有同名节点，如果有，直接抛受检异常。获取时间，新增节点，返回ID。
  - 删除节点：接受节点的ID。如果是文件夹，利用SQL语句递归删除。从数据库删除节点。
  - 移动节点`moveNode(id, targetId)`：接受目标文件夹ID、节点ID。检查目标文件夹是不是文件夹，不是就直接抛受检异常。检查对应目录下有没有同名节点。没有的话，修改节点的`parent_id`，修改节点时间。如果有的话，如果类型不同，抛出受检异常。如果同为文件，直接同名节点，修改当前节点的`parent_id`。如果同为文件夹，抛出异常（最小可行产品）。
  - 合并文件夹（private）：接受来源`sourceId`和目标`destinationId`两个ID。检查来源和目标都是文件夹。对所有以`sourceId`为`parent_id`的节点，将其`parent_id`改到`destinationId`。
  - 增加下载次数：接受节点ID，调用`FileMetaDao`增加节点的下载次数。

- `FileStorageDao`
  - 保存文件`insertFile(connection, hashString, size)`：重复的直接抛出受检异常。不应该发生。
  - 文件引用计数自增或自减`incrementReferenceCount(connection, hashString)` `decrementReferenceCount(connection, hashString)`：影响行数都应该恰为$1$，否则抛异常。
  - 查询文件`FileStorageEntity getByHash(connection, hashString)`：接受一个哈希值。返回对应的记录或空指针。
- `FileMetaDao`
  - 增加文件记录`long insertFile(connection, parentId, filename, hashString, size, time)`：返回`id`。
  - 增加文件夹记录`long insertFolder(connection, parentId, filename, time)`：用`parent_id`、文件名和当前时间创建记录，返回`id`。
  - 删除节点`removeById(connection, id)`：删除对应节点。
  - 删除目录下所有节点`removeByParentId(connection, parentId)`：接受目录ID，删除所有以该目录节点为`parent_id`的节点。
  - 列出目录`ArrayList<FileMetaEntity> getByParentId(connection, parentId)`：返回所有以`parentId`为`parent_id`的节点。
  - 修改元数据`updateById(connection, id, size, time)`：接受节点ID、大小和时间。
  - 增加下载次数`incrementDownloadCountById(connection, id)`：接受节点ID，将该节点的下载次数自增。

### UI

有时间用Java写个桌面端，没时间就直接用AI写个前端。

- 配置连接
- 文件列表视图
- 上传下载管理面板，包括进度条等

